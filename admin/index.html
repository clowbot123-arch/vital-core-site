<!doctype html>
<html lang="en">
<head> <meta charset="utf-8" /> <meta name="viewport" content="width=device-width, initial-scale=1" /> <title>VitalCore Admin</title> <link rel="stylesheet" href="/css/style.css" /> <style> :root{ --panel:#ffffff; --panel2:rgba(255,255,255,.72); --border:rgba(17,24,39,.10); --shadow2: 0 18px 55px rgba(0,0,0,.10); --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; } body{ background: radial-gradient(1200px 650px at 15% -10%, rgba(39,174,96,.20), transparent 60%), radial-gradient(900px 520px at 90% 10%, rgba(230,126,34,.14), transparent 55%), radial-gradient(900px 520px at 40% 110%, rgba(26,26,46,.12), transparent 55%), var(--light); } .wrap{max-width:1260px;margin:26px auto;padding:0 16px;} .topbar{ display:flex; align-items:center; justify-content:space-between; gap:14px; background:var(--panel2); border:1px solid var(--border); border-radius:22px; padding:14px 16px; box-shadow: var(--shadow2); backdrop-filter: blur(10px); } .brand{ display:flex; align-items:center; gap:12px; } .brand .mark{ width:44px;height:44px;border-radius:14px; background: linear-gradient(135deg, rgba(39,174,96,.95), rgba(30,132,73,.95)); box-shadow: 0 10px 28px rgba(39,174,96,.25); } .brand h1{margin:0;font-size:1.45rem;line-height:1.1;} .brand p{margin:2px 0 0 0; color:var(--text-light); font-weight:600; font-size:.95rem} .status{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; } .pill{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background: rgba(39,174,96,.10); border: 1px solid rgba(39,174,96,.22); color: var(--secondary); font-weight:800; font-size:.95rem; white-space:nowrap; } .pill.warn{background:rgba(230,126,34,.10);border-color:rgba(230,126,34,.22)} .pill .dot{width:10px;height:10px;border-radius:50%;background:var(--primary); box-shadow:0 0 0 4px rgba(39,174,96,.18)} .pill.warn .dot{background:var(--accent); box-shadow:0 0 0 4px rgba(230,126,34,.18)} .layout{display:grid;grid-template-columns: 320px 1fr;gap:16px;margin-top:16px;align-items:start;} .sidebar,.panel{ background:var(--panel2); border:1px solid var(--border); border-radius:22px; box-shadow: var(--shadow2); backdrop-filter: blur(10px); overflow:hidden; } .sidebar{padding:14px;} .navbtn{ width:100%; display:flex; align-items:center; justify-content:space-between; padding:12px 12px; border-radius:16px; border:1px solid transparent; background:transparent; cursor:pointer; font-weight:900; color:var(--secondary); } .navbtn small{color:var(--text-light); font-weight:800} .navbtn.active{ background:rgba(39,174,96,.10); border-color:rgba(39,174,96,.20); } .sidebar .hint{margin-top:10px;color:var(--text-light);font-weight:600;font-size:.95rem;line-height:1.5} .sidebar code{font-family:var(--mono);font-size:.92rem} .panel{padding:16px;} .panelhead{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;margin-bottom:10px;} .panelhead h2{margin:0;font-size:1.65rem} .panelhead .sub{margin:0;color:var(--text-light);font-weight:600;max-width:70ch} .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:flex-end} .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px;} label{display:block;margin-top:10px;font-weight:900;color:var(--secondary);} textarea,input,select{ width:100%; padding:12px 12px; border:1px solid rgba(17,24,39,.12); background:#fff; color:var(--text); border-radius:16px; outline:none; } textarea{min-height:110px;font-family:var(--mono)} textarea:focus,input:focus,select:focus{ border-color: rgba(39,174,96,.55); box-shadow: 0 0 0 4px rgba(39,174,96,.14); } .actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap} .btn.small{padding:10px 14px;border-radius:14px;font-weight:900} .btn-danger{background:#b42318;color:#fff} .btn-danger:hover{filter:brightness(.95);transform:translateY(-2px)} .split{display:grid;grid-template-columns: 1.15fr .85fr;gap:14px;} .card{ background: rgba(255,255,255,.88); border:1px solid rgba(17,24,39,.10); border-radius:22px; padding:14px; box-shadow: 0 12px 32px rgba(0,0,0,.06); } .tablewrap{margin-top:12px} table{width:100%;border-collapse:separate;border-spacing:0 8px} th{font-size:.85rem;letter-spacing:.02em;text-transform:uppercase;color:var(--text-light);text-align:left;padding:0 10px} td{padding:12px 10px;background:#fff;border-top:1px solid rgba(17,24,39,.06);border-bottom:1px solid rgba(17,24,39,.06)} tr td:first-child{border-left:1px solid rgba(17,24,39,.06);border-top-left-radius:16px;border-bottom-left-radius:16px} tr td:last-child{border-right:1px solid rgba(17,24,39,.06);border-top-right-radius:16px;border-bottom-right-radius:16px} .rowbtn{padding:8px 10px;border-radius:12px;border:1px solid rgba(17,24,39,.10);background:rgba(17,24,39,.02);font-weight:900;cursor:pointer} .rowbtn:hover{background:rgba(39,174,96,.10);border-color:rgba(39,174,96,.20)} .toast{ position: fixed; bottom: 18px; right: 18px; max-width: 420px; background: rgba(17,24,39,.92); color: #e8eefc; border: 1px solid rgba(255,255,255,.14); border-radius: 18px; padding: 12px 14px; box-shadow: 0 20px 60px rgba(0,0,0,.35); display:none; z-index: 9999; } .toast.show{display:block} .toast .t{font-weight:900} .toast .m{opacity:.9;margin-top:4px;white-space:pre-wrap;font-family:var(--mono);font-size:.9rem} .muted{color:var(--text-light);font-weight:600} .invalid{ border-color: rgba(180,35,24,.65) !important; box-shadow: 0 0 0 4px rgba(180,35,24,.14) !important; } .err{ color:#b42318; font-weight:800; font-size:.88rem; margin-top:6px; display:none; } .err.show{display:block} .empty{ padding:14px; border:1px dashed rgba(17,24,39,.18); border-radius:18px; background:rgba(255,255,255,.65); color:var(--text-light); font-weight:700; line-height:1.55; } @media (max-width: 1050px){ .layout{grid-template-columns:1fr} .split{grid-template-columns:1fr} } </style>
</head>
<body> <div class="wrap"> <div class="topbar"> <div class="brand"> <div class="mark" aria-hidden="true"></div> <div> <h1>VitalCore Admin</h1> <p>Products + Blog — edit without redeploy</p> </div> </div> <div class="status"> <span class="pill warn"><span class="dot"></span>Local dev</span> <span class="pill warn" id="api_health"><span class="dot"></span>API: <code id="api_base"></code> <span id="api_health_txt">checking…</span></span> </div> </div> <div class="layout"> <aside class="sidebar"> <button class="navbtn active" data-view="products">Products <small id="count_products">0</small></button> <button class="navbtn" data-view="posts">Blog posts <small id="count_posts">0</small></button> <p class="hint">Local testing uses the built-in API at <code>/api</code> via <code>dev_server.py</code>.<br/>Production should put <strong>Cloudflare Access</strong> in front of the real API.</p> </aside> <main class="panel"> <!-- PRODUCTS VIEW --> <section id="view_products"> <div class="panelhead"> <div> <h2>Products</h2> <p class="sub">Create, edit and deactivate affiliate products. Changes go live instantly (once API is deployed).</p> </div> <div class="toolbar"> <select id="p_lang" aria-label="language"> <option value="en">en</option> <option value="de">de</option> </select> <button class="btn btn-secondary small" id="btn_load_products">Refresh list</button> <button class="btn btn-primary small" id="btn_new_product">New product</button> </div> </div> <div class="split"> <div class="card"> <h3 style="margin:0 0 6px 0">Editor</h3> <p class="muted" style="margin:0 0 8px 0">Fill the fields and press Save.</p> <input type="hidden" id="p_id" value="" /> <div class="grid2"> <div> <label>Slug</label> <input id="p_slug" placeholder="advanced-amino" /> <div class="err" id="err_p_slug"></div> </div> <div> <label>Tag</label> <input id="p_tag" placeholder="Recovery" /> </div> </div> <label>Title</label> <input id="p_title" placeholder="Advanced Amino Acid Complex" /> <div class="err" id="err_p_title"></div> <label>Description</label> <textarea id="p_desc" placeholder="Short description..."></textarea> <label>Bullets (one per line)</label> <textarea id="p_bullets" placeholder="Bullet 1\nBullet 2\nBullet 3"></textarea> <div class="grid2"> <div> <label>Old price</label> <input id="p_old" placeholder="€108.80" /> </div> <div> <label>New price</label> <input id="p_new" placeholder="€39.95" /> </div> </div> <label>Price unit (optional)</label> <input id="p_unit" placeholder="/ bottle" /> <label>Pexels image URL</label> <input id="p_img" placeholder="https://images.pexels.com/photos/..." /> <div class="err" id="err_p_img"></div> <label>Affiliate URL</label> <input id="p_aff" placeholder="https://...#aff=ClawDave" /> <div class="err" id="err_p_aff"></div> <div class="actions"> <button class="btn btn-primary small" id="btn_save_product">Save</button> <button class="btn btn-secondary small" id="btn_clear_product">Clear</button> <button class="btn btn-danger small" id="btn_delete_product" style="display:none">Deactivate</button> </div> </div> <div class="card"> <h3 style="margin:0 0 6px 0">Live preview</h3> <p class="muted" style="margin:0 0 10px 0">This is how it will look on the homepage.</p> <div style="display:flex;gap:12px;align-items:flex-start"> <img id="prev_img" src="" alt="" style="width:120px;height:120px;object-fit:cover;border-radius:18px;border:1px solid rgba(17,24,39,.10);background:rgba(17,24,39,.03)" / decoding="async" loading="eager" fetchpriority="high"> <div> <div class="pill" style="display:inline-flex;margin-bottom:8px"><span class="dot"></span><span id="prev_tag">Tag</span></div> <div style="font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:800;margin:0 0 6px 0" id="prev_title">Title</div> <div class="muted" id="prev_desc">Description…</div> <div style="margin-top:10px;font-weight:900"> <span style="text-decoration:line-through;opacity:.55" id="prev_old">€0</span> <span style="margin-left:10px;color:var(--primary)" id="prev_new">€0</span> <span class="muted" id="prev_unit"></span> </div> </div> </div> <div class="tablewrap"> <table> <thead> <tr> <th>ID</th> <th>Title</th> <th>Tag</th> <th>Price</th> <th>Actions</th> </tr> </thead> <tbody id="products_table"></tbody> </table> </div> </div> </div> </section> <!-- POSTS VIEW --> <section id="view_posts" style="display:none"> <div class="panelhead"> <div> <h2>Blog posts</h2> <p class="sub">Manage the blog index. (We can keep full articles static for SEO and still manage the index here.)</p> </div> <div class="toolbar"> <select id="b_lang" aria-label="language"> <option value="en">en</option> <option value="de">de</option> </select> <button class="btn btn-secondary small" id="btn_load_posts">Refresh list</button> <button class="btn btn-primary small" id="btn_new_post">New post</button> </div> </div> <div class="split"> <div class="card"> <h3 style="margin:0 0 6px 0">Editor</h3> <p class="muted" style="margin:0 0 8px 0">Create an index entry (and optional HTML content).</p> <input type="hidden" id="b_id" value="" /> <div class="grid2"> <div> <label>Slug</label> <input id="b_slug" placeholder="sleep-optimization" /> <div class="err" id="err_b_slug"></div> </div> <div> <label>Category</label> <input id="b_cat" placeholder="Sleep" /> </div> </div> <label>Title</label> <input id="b_title" placeholder="Sleep Optimization: The Ultimate Guide" /> <div class="err" id="err_b_title"></div> <label>Excerpt</label> <textarea id="b_excerpt" placeholder="Short excerpt..."></textarea> <label>Hero image URL (Pexels)</label> <input id="b_img" placeholder="https://images.pexels.com/photos/..." /> <div class="err" id="err_b_img"></div> <label>Published at (ISO 8601)</label> <input id="b_pub" placeholder="2026-02-14T22:00:00+00:00" /> <div class="err" id="err_b_pub"></div> <label>Content HTML (optional)</label> <textarea id="b_html" placeholder="<p>...</p>"></textarea> <div class="actions"> <button class="btn btn-primary small" id="btn_save_post">Save</button> <button class="btn btn-secondary small" id="btn_clear_post">Clear</button> <button class="btn btn-danger small" id="btn_delete_post" style="display:none">Deactivate</button> </div> </div> <div class="card"> <h3 style="margin:0 0 6px 0">List</h3> <p class="muted" style="margin:0 0 10px 0">Click “Edit” on a row to load it.</p> <div class="tablewrap"> <table> <thead> <tr> <th>ID</th> <th>Title</th> <th>Category</th> <th>Published</th> <th>Slug</th> <th>Actions</th> </tr> </thead> <tbody id="posts_table"></tbody> </table> </div> </div> </div> </section> </main> </div> </div> <div class="toast" id="toast"> <div class="t" id="toast_t">OK</div> <div class="m" id="toast_m">…</div> </div> <script> // Local dev server serves API at the same origin. // Production should keep "/api" and route the Worker there (recommended). const API_BASE = "/api"; document.getElementById('api_base').textContent = API_BASE; const $ = (id) => document.getElementById(id); function setApiHealth(ok, msg){ const pill = $('api_health'); const t = $('api_health_txt'); if(!pill || !t) return; t.textContent = msg || (ok ? "online" : "offline"); pill.classList.toggle('warn', !ok); } function withFriendlyError(e){ const msg = String(e && e.message ? e.message : e || "Unknown error"); if(msg.includes('Failed to fetch') || msg.includes('NetworkError') || msg.includes('AbortError')){ return "Cannot reach API. Check dev_server.py / Worker route and try again."; } return msg.replace(/^Error:\s*/,''); } const LS_KEY = 'vitalcore_admin_state_v1'; const state = { view: 'products', p_lang: 'en', b_lang: 'en', touched: { p_slug:false, b_slug:false }, dirty: { products:false, posts:false }, }; function loadState(){ try{ const raw = localStorage.getItem(LS_KEY); if(!raw) return; const s = JSON.parse(raw); if(s && typeof s==='object'){ if(s.view) state.view = s.view; if(s.p_lang) state.p_lang = s.p_lang; if(s.b_lang) state.b_lang = s.b_lang; } }catch(e){} } function saveState(){ try{ localStorage.setItem(LS_KEY, JSON.stringify({ view: state.view, p_lang: $('p_lang').value, b_lang: $('b_lang').value, })); }catch(e){} } function nowIso(){ return new Date().toISOString().replace(/\.\d{3}Z$/, '+00:00'); } function slugify(s){ return String(s||'') .trim() .toLowerCase() .replace(/["'\u2019]/g,'') .replace(/[^a-z0-9]+/g,'-') .replace(/^-+|-+$/g,'') .replace(/-+/g,'-'); } function setErr(inputId, errId, msg){ const inp = $(inputId); const el = $(errId); if(!inp || !el) return; if(msg){ inp.classList.add('invalid'); el.textContent = msg; el.classList.add('show'); } else { inp.classList.remove('invalid'); el.textContent = ''; el.classList.remove('show'); } } function validSlug(s){ return /^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(String(s||'')); } function validUrlOrEmpty(s){ const v = String(s||'').trim(); if(!v) return true; try{ const u = new URL(v); return (u.protocol === 'http:' || u.protocol === 'https:'); }catch(e){ return false; } } function markDirty(which){ state.dirty[which] = true; } function clearDirty(which){ state.dirty[which] = false; } function confirmLoseEdits(which){ if(!state.dirty[which]) return true; return confirm('Discard unsaved changes?'); } function currentView(){ return ($('view_posts').style.display === 'none') ? 'products' : 'posts'; } function toast(title, msg){ $('toast_t').textContent = title; $('toast_m').textContent = msg; const t = $('toast'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2600); } function bulletsToArray(s){ return (s||"").split("\n").map(x=>x.trim()).filter(Boolean); } async function api(path, opts={}){ let res; try{ res = await fetch(API_BASE + path, { ...opts, headers: { "content-type": "application/json", ...(opts.headers||{}) } }); }catch(e){ setApiHealth(false, 'offline'); throw e; } const txt = await res.text(); let data; try{ data = JSON.parse(txt); } catch(e){ data = { raw: txt }; } if(!res.ok){ setApiHealth(false, 'error'); const msg = (data && data.error) ? data.error : (res.status + " " + (res.statusText||"HTTP")); throw new Error(msg); } setApiHealth(true, 'online'); return data; } function setView(name){ const cur = currentView(); if(cur !== name){ if(cur==='products' && !confirmLoseEdits('products')) return; if(cur==='posts' && !confirmLoseEdits('posts')) return; } state.view = name; saveState(); document.querySelectorAll('.navbtn').forEach(b=>b.classList.toggle('active', b.dataset.view===name)); $('view_products').style.display = (name==='products') ? '' : 'none'; $('view_posts').style.display = (name==='posts') ? '' : 'none'; } document.querySelectorAll('.navbtn').forEach(btn=>{ btn.addEventListener('click', ()=>setView(btn.dataset.view)); }); // -------- PRODUCTS -------- function clearProduct(force=false){ if(!force && !confirmLoseEdits('products')) return; $('p_id').value=''; $('p_slug').value=''; $('p_title').value=''; $('p_tag').value=''; $('p_desc').value=''; $('p_bullets').value=''; $('p_old').value=''; $('p_new').value=''; $('p_unit').value=''; $('p_img').value=''; $('p_aff').value=''; $('btn_delete_product').style.display='none'; setErr('p_slug','err_p_slug',''); setErr('p_title','err_p_title',''); setErr('p_img','err_p_img',''); setErr('p_aff','err_p_aff',''); clearDirty('products'); state.touched.p_slug = false; updatePreview(); } function updatePreview(){ $('prev_tag').textContent = $('p_tag').value || 'Tag'; $('prev_title').textContent = $('p_title').value || 'Title'; $('prev_desc').textContent = $('p_desc').value || 'Description…'; $('prev_old').textContent = $('p_old').value || '€0'; $('prev_new').textContent = $('p_new').value || '€0'; $('prev_unit').textContent = $('p_unit').value || ''; const img = $('p_img').value || ''; $('prev_img').src = img; $('prev_img').style.opacity = img ? '1' : '0.35'; } ['p_slug','p_title','p_tag','p_desc','p_bullets','p_old','p_new','p_unit','p_img','p_aff'].forEach(id=>{ $(id).addEventListener('input', ()=>{ markDirty('products'); updatePreview(); }); }); $('p_slug').addEventListener('input', ()=>{ state.touched.p_slug = true; }); $('p_title').addEventListener('input', ()=>{ if(!state.touched.p_slug && !$('p_slug').value.trim()){ $('p_slug').value = slugify($('p_title').value); } }); async function loadProducts(){ const lang = $('p_lang').value; state.p_lang = lang; saveState(); const out = await api('/products?lang=' + encodeURIComponent(lang)); const items = out.items || []; $('count_products').textContent = String(items.length); const tb = $('products_table'); tb.innerHTML=''; if(items.length===0){ const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="5"><div class="empty">No products yet. Click <strong>New product</strong> to create one. Tip: press <code>Ctrl/Cmd+S</code> to save.</div></td>`; tb.appendChild(tr); toast('Products', `Loaded 0 items (${lang}).`); return; } for(const it of items){ const tr = document.createElement('tr'); tr.innerHTML = ` <td>${it.id}</td> <td><strong>${escapeHtml(it.title)}</strong><div class="muted">${escapeHtml(it.slug)}</div></td> <td>${escapeHtml(it.tag||'')}</td> <td>${escapeHtml(it.price_old||'')} → <span style="color:var(--primary);font-weight:900">${escapeHtml(it.price_new||'')}</span></td> <td style="display:flex;gap:8px;align-items:center"> <button class="rowbtn" data-act="edit" data-id="${it.id}">Edit</button> <button class="rowbtn" data-act="deact" data-id="${it.id}">Deactivate</button> </td> `; tb.appendChild(tr); } tb.querySelectorAll('button[data-act="edit"]').forEach(b=>b.addEventListener('click', ()=>editProduct(Number(b.dataset.id), items))); tb.querySelectorAll('button[data-act="deact"]').forEach(b=>b.addEventListener('click', ()=>deactivateProduct(Number(b.dataset.id)))); toast('Products', `Loaded ${items.length} items (${lang}).`); } function editProduct(id, items){ if(!confirmLoseEdits('products')) return; const it = items.find(x=>Number(x.id)===Number(id)); if(!it) return; $('p_id').value = it.id; $('p_slug').value = it.slug || ''; $('p_title').value = it.title || ''; $('p_tag').value = it.tag || ''; $('p_desc').value = it.description || ''; try{ const bullets = JSON.parse(it.bullets_json || '[]'); $('p_bullets').value = (Array.isArray(bullets) ? bullets : []).join('\n'); }catch(e){ $('p_bullets').value = ''; } $('p_old').value = it.price_old || ''; $('p_new').value = it.price_new || ''; $('p_unit').value = it.price_unit || ''; $('p_img').value = it.image_url || ''; $('p_aff').value = it.affiliate_url || ''; $('btn_delete_product').style.display='inline-block'; setErr('p_slug','err_p_slug',''); setErr('p_title','err_p_title',''); setErr('p_img','err_p_img',''); setErr('p_aff','err_p_aff',''); clearDirty('products'); state.touched.p_slug = true; updatePreview(); toast('Editor', `Loaded product #${it.id}`); } function validateProduct(payload){ let ok = true; const s = payload.slug || ''; if(!s){ setErr('p_slug','err_p_slug','Slug is required.'); ok=false; } else if(!validSlug(s)){ setErr('p_slug','err_p_slug','Use lowercase letters, numbers and hyphens only.'); ok=false; } else setErr('p_slug','err_p_slug',''); if(!payload.title){ setErr('p_title','err_p_title','Title is required.'); ok=false; } else setErr('p_title','err_p_title',''); if(!validUrlOrEmpty(payload.image_url)){ setErr('p_img','err_p_img','Image URL must be http(s).'); ok=false; } else setErr('p_img','err_p_img',''); if(!validUrlOrEmpty(payload.affiliate_url)){ setErr('p_aff','err_p_aff','Affiliate URL must be http(s).'); ok=false; } else setErr('p_aff','err_p_aff',''); if(!ok) toast('Fix fields', 'Please correct the highlighted fields.'); return ok; } async function saveProduct(){ const lang = $('p_lang').value; const payload = { lang, slug: $('p_slug').value.trim(), title: $('p_title').value.trim(), tag: $('p_tag').value.trim(), description: $('p_desc').value.trim(), bullets: bulletsToArray($('p_bullets').value), price_old: $('p_old').value.trim(), price_new: $('p_new').value.trim(), price_unit: $('p_unit').value.trim(), image_url: $('p_img').value.trim(), affiliate_url: $('p_aff').value.trim(), active: true, }; const ok = validateProduct(payload); if(!ok) return; const id = $('p_id').value; if(id){ await api('/products/' + encodeURIComponent(id), { method:'PUT', body: JSON.stringify(payload) }); toast('Saved', `Updated product #${id}`); } else { const out = await api('/products', { method:'POST', body: JSON.stringify(payload) }); toast('Saved', `Created product #${out.id}`); } clearDirty('products'); await loadProducts(); } async function deactivateProduct(id){ if(!confirm('Deactivate product #' + id + '?')) return; await api('/products/' + encodeURIComponent(id), { method:'DELETE' }); toast('Deactivated', 'Product #' + id); await loadProducts(); clearProduct(); } // -------- POSTS -------- function clearPost(force=false){ if(!force && !confirmLoseEdits('posts')) return; $('b_id').value=''; $('b_slug').value=''; $('b_title').value=''; $('b_cat').value=''; $('b_excerpt').value=''; $('b_img').value=''; $('b_html').value=''; $('b_pub').value = nowIso(); $('btn_delete_post').style.display='none'; setErr('b_slug','err_b_slug',''); setErr('b_title','err_b_title',''); setErr('b_pub','err_b_pub',''); setErr('b_img','err_b_img',''); clearDirty('posts'); state.touched.b_slug = false; } async function loadPosts(){ const lang = $('b_lang').value; state.b_lang = lang; saveState(); const out = await api('/posts?lang=' + encodeURIComponent(lang)); const items = out.items || []; $('count_posts').textContent = String(items.length); const tb = $('posts_table'); tb.innerHTML=''; if(items.length===0){ const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="6"><div class="empty">No posts yet. Click <strong>New post</strong> to create one. Tip: press <code>Ctrl/Cmd+S</code> to save.</div></td>`; tb.appendChild(tr); toast('Posts', `Loaded 0 items (${lang}).`); return; } for(const it of items){ const tr = document.createElement('tr'); tr.innerHTML = ` <td>${it.id}</td> <td><strong>${escapeHtml(it.title)}</strong><div class="muted">${escapeHtml(it.excerpt||'')}</div></td> <td>${escapeHtml(it.category||'')}</td> <td><code>${escapeHtml((it.published_at||'').slice(0,10))}</code></td> <td><code>${escapeHtml(it.slug||'')}</code></td> <td style="display:flex;gap:8px;align-items:center"> <button class="rowbtn" data-act="edit" data-id="${it.id}">Edit</button> <button class="rowbtn" data-act="deact" data-id="${it.id}">Deactivate</button> </td> `; tb.appendChild(tr); } tb.querySelectorAll('button[data-act="edit"]').forEach(b=>b.addEventListener('click', ()=>editPost(Number(b.dataset.id), items))); tb.querySelectorAll('button[data-act="deact"]').forEach(b=>b.addEventListener('click', ()=>deactivatePost(Number(b.dataset.id)))); toast('Posts', `Loaded ${items.length} items (${lang}).`); } function editPost(id, items){ if(!confirmLoseEdits('posts')) return; const it = items.find(x=>Number(x.id)===Number(id)); if(!it) return; $('b_id').value = it.id; $('b_slug').value = it.slug || ''; $('b_title').value = it.title || ''; $('b_cat').value = it.category || ''; $('b_excerpt').value = it.excerpt || ''; $('b_img').value = it.hero_image_url || ''; $('b_pub').value = it.published_at || nowIso(); $('b_html').value = it.content_html || ''; $('btn_delete_post').style.display='inline-block'; setErr('b_slug','err_b_slug',''); setErr('b_title','err_b_title',''); setErr('b_pub','err_b_pub',''); setErr('b_img','err_b_img',''); clearDirty('posts'); state.touched.b_slug = true; toast('Editor', `Loaded post #${it.id}`); } ['b_slug','b_title','b_cat','b_excerpt','b_img','b_pub','b_html'].forEach(id=>{ $(id).addEventListener('input', ()=>{ markDirty('posts'); }); }); $('b_slug').addEventListener('input', ()=>{ state.touched.b_slug = true; }); $('b_title').addEventListener('input', ()=>{ if(!state.touched.b_slug && !$('b_slug').value.trim()){ $('b_slug').value = slugify($('b_title').value); } }); function validatePost(payload){ let ok = true; const s = payload.slug || ''; if(!s){ setErr('b_slug','err_b_slug','Slug is required.'); ok=false; } else if(!validSlug(s)){ setErr('b_slug','err_b_slug','Use lowercase letters, numbers and hyphens only.'); ok=false; } else setErr('b_slug','err_b_slug',''); if(!payload.title){ setErr('b_title','err_b_title','Title is required.'); ok=false; } else setErr('b_title','err_b_title',''); if(!validUrlOrEmpty(payload.hero_image_url)){ setErr('b_img','err_b_img','Hero image URL must be http(s).'); ok=false; } else setErr('b_img','err_b_img',''); // published_at should be parseable ISO; allow empty (we will default it). const pv = String(payload.published_at||'').trim(); if(pv){ const d = new Date(pv); if(isNaN(d.getTime())){ setErr('b_pub','err_b_pub','Use ISO 8601, e.g. 2026-02-14T22:00:00+00:00'); ok=false; } else setErr('b_pub','err_b_pub',''); } else { setErr('b_pub','err_b_pub',''); } if(!ok) toast('Fix fields', 'Please correct the highlighted fields.'); return ok; } async function savePost(){ const lang = $('b_lang').value; const payload = { lang, slug: $('b_slug').value.trim(), title: $('b_title').value.trim(), category: $('b_cat').value.trim(), excerpt: $('b_excerpt').value.trim(), hero_image_url: $('b_img').value.trim(), content_html: $('b_html').value, published_at: ($('b_pub').value||'').trim() || nowIso(), active: true, }; const ok = validatePost(payload); if(!ok) return; const id = $('b_id').value; if(id){ await api('/posts/' + encodeURIComponent(id), { method:'PUT', body: JSON.stringify(payload) }); toast('Saved', `Updated post #${id}`); } else { const out = await api('/posts', { method:'POST', body: JSON.stringify(payload) }); toast('Saved', `Created post #${out.id}`); } clearDirty('posts'); await loadPosts(); } async function deactivatePost(id){ if(!confirm('Deactivate post #' + id + '?')) return; await api('/posts/' + encodeURIComponent(id), { method:'DELETE' }); toast('Deactivated', 'Post #' + id); await loadPosts(); clearPost(); } // Helpers function escapeHtml(s){ return String(s||"") .replaceAll('&','&amp;') .replaceAll('<','&lt;') .replaceAll('>','&gt;') .replaceAll('"','&quot;') .replaceAll("'",'&#039;'); } // Wire buttons $('btn_load_products').onclick = () => loadProducts().catch(e=>toast('Error', withFriendlyError(e))); $('btn_new_product').onclick = () => { clearProduct(); toast('Editor', 'New product'); $('p_title').focus(); }; $('btn_save_product').onclick = async () => { const b = $('btn_save_product'); if(b.disabled) return; b.disabled = true; try{ await saveProduct(); } catch(e){ toast('Error', withFriendlyError(e)); } finally{ b.disabled = false; } }; $('btn_clear_product').onclick = () => clearProduct(); $('btn_delete_product').onclick = () => { const id = Number($('p_id').value||0); if(id) deactivateProduct(id).catch(e=>toast('Error', withFriendlyError(e))); }; $('p_lang').onchange = (e) => { if(state.dirty.products && !confirmLoseEdits('products')){ $('p_lang').value = state.p_lang || 'en'; return; } loadProducts().catch(err=>toast('Error', withFriendlyError(err))); }; $('btn_load_posts').onclick = () => loadPosts().catch(e=>toast('Error', withFriendlyError(e))); $('btn_new_post').onclick = () => { clearPost(); toast('Editor', 'New post'); $('b_title').focus(); }; $('btn_save_post').onclick = async () => { const b = $('btn_save_post'); if(b.disabled) return; b.disabled = true; try{ await savePost(); } catch(e){ toast('Error', withFriendlyError(e)); } finally{ b.disabled = false; } }; $('btn_clear_post').onclick = () => clearPost(); $('btn_delete_post').onclick = () => { const id = Number($('b_id').value||0); if(id) deactivatePost(id).catch(e=>toast('Error', withFriendlyError(e))); }; $('b_lang').onchange = () => { if(state.dirty.posts && !confirmLoseEdits('posts')){ $('b_lang').value = state.b_lang || 'en'; return; } loadPosts().catch(err=>toast('Error', withFriendlyError(err))); }; // Keyboard shortcuts document.addEventListener('keydown', (e)=>{ const isMac = /Mac|iPhone|iPad/.test(navigator.platform); const mod = isMac ? e.metaKey : e.ctrlKey; if(mod && e.key.toLowerCase()==='s'){ e.preventDefault(); const v = currentView(); if(v==='products') saveProduct().catch(err=>toast('Error', withFriendlyError(err))); else savePost().catch(err=>toast('Error', withFriendlyError(err))); return; } if(e.key==='Escape'){ const v = currentView(); if(v==='products') clearProduct(); else clearPost(); } }); // Init loadState(); $('p_lang').value = state.p_lang || 'en'; $('b_lang').value = state.b_lang || 'en'; clearProduct(true); clearPost(true); updatePreview(); setView(state.view || 'products'); loadProducts().catch(()=>setApiHealth(false, 'offline')); loadPosts().catch(()=>{});
</script>
</body>
</html>
